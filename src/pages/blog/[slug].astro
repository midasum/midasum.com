---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Image, getImage } from 'astro:assets';
import { AUTHOR } from '../../consts';
import { resolveBlogImage } from '../../utils/resolveImage';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: any;
}

const { post } = Astro.props;
const rendered = await post.render();
const { Content } = rendered;

// Handle image if provided
let articleImage: string | ReturnType<typeof getImage> | null = null;
if (post.data.image) {
  try {
    // Try to resolve as a local asset first
    const imageUrl = await resolveBlogImage(post.data.image, post.slug);
    
    // If resolution succeeded and it's a local path (starts with /), import it
    if (imageUrl.startsWith('/') && !imageUrl.startsWith('http')) {
      // Import the image asset for use with Image component
      let imageAsset: any;
      const imagePath = post.data.image.startsWith('./') 
        ? post.data.image.slice(2)
        : post.data.image.startsWith('/')
        ? post.data.image.slice(1)
        : post.data.image;
      const imagePathWithExt = imagePath.includes('.') ? imagePath : `${imagePath}.svg`;
      
      try {
        const imageModule = await import(`../../content/blog/${post.slug}/${imagePathWithExt}`);
        imageAsset = imageModule.default;
        const processedImage = await getImage({ src: imageAsset });
        articleImage = processedImage;
      } catch {
        // Fallback to URL string
        articleImage = imageUrl;
      }
    } else {
      // External URL or fallback
      articleImage = imageUrl;
    }
  } catch {
    // If resolution fails, use as external URL
    articleImage = post.data.image;
  }
}
---

<BaseLayout title={`${post.data.title} - midasum`}>
  <article class="blog-post">
    <div class="blog-meta">
      <time class="blog-date" datetime={post.data.date.toISOString()}>
        {post.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
      </time>
      <span class="blog-category">{post.data.category}</span>
    </div>
    <h1 class="section-title">{post.data.title}</h1>
    {articleImage && (
      <figure class="article-image">
        {typeof articleImage === 'string' ? (
          <img src={articleImage} alt={post.data.title} />
        ) : (
          <Image src={articleImage.src} alt={post.data.title} width={articleImage.width} height={articleImage.height} />
        )}
      </figure>
    )}
    <div class="blog-post-content">
      <Content />
    </div>
    <p class="blog-post-signature">
      <em>{AUTHOR.name} <span class="blog-post-brand">({AUTHOR.brand})</span></em>
    </p>
  </article>
</BaseLayout>

