---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import { AUTHOR } from '../../consts';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: any;
}

const { post } = Astro.props;
const rendered = await post.render();
const { Content } = rendered;

// Handle image if provided
let articleImage = null;
if (post.data.image) {
  try {
    // For relative paths (./image.svg), import from the same folder as the post
    if (post.data.image.startsWith('./')) {
      const imagePath = post.data.image.slice(2); // Remove './'
      const imagePathWithExt = imagePath.includes('.') ? imagePath : `${imagePath}.svg`;
      const imageModule = await import(`../../content/blog/${post.slug}/${imagePathWithExt}?url`);
      articleImage = imageModule.default;
    } else if (post.data.image.startsWith('/')) {
      // Absolute path from content directory
      const imagePath = post.data.image.slice(1);
      const imagePathWithExt = imagePath.includes('.') ? imagePath : `${imagePath}.svg`;
      const imageModule = await import(`../../content/blog/${imagePathWithExt}?url`);
      articleImage = imageModule.default;
    } else {
      // Try relative to post folder first, then fallback to external URL
      try {
        const imagePathWithExt = post.data.image.includes('.') ? post.data.image : `${post.data.image}.svg`;
        const imageModule = await import(`../../content/blog/${post.slug}/${imagePathWithExt}?url`);
        articleImage = imageModule.default;
      } catch {
        articleImage = post.data.image; // External URL
      }
    }
  } catch {
    // If import fails, use as external URL
    articleImage = post.data.image;
  }
}
---

<BaseLayout title={`${post.data.title} - midasum`}>
  <article class="blog-post">
    <div class="blog-meta">
      <time class="blog-date" datetime={post.data.date.toISOString()}>
        {post.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
      </time>
      <span class="blog-category">{post.data.category}</span>
    </div>
    <h1 class="section-title">{post.data.title}</h1>
    {articleImage && (
      <figure class="article-image">
        {typeof articleImage === 'string' ? (
          <img src={articleImage} alt={post.data.title} />
        ) : (
          <Image src={articleImage} alt={post.data.title} />
        )}
      </figure>
    )}
    <div class="blog-post-content">
      <Content />
    </div>
    <p class="blog-post-signature">
      <em>{AUTHOR.name} <span class="blog-post-brand">({AUTHOR.brand})</span></em>
    </p>
  </article>
</BaseLayout>

